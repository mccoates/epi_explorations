---
title: "Comparison of Methods for Analyzing RCT Data Regarding Baseline Treatment Group Differences"
format: html
editor: visual
---

### Motivation:

-   Seeing multiple approaches for analyzing fairly basic structures of RCT data
-   Reading that some strategies better adjust for **regression to the mean** because of baseline differences in treatment and control group (Twisk, 2018)
-   Wanting to understand the DAG structures that illustrate the "difference in differences" and "longitudinal analysis of covariance" approaches/implied data generating processes

```{r}
#| echo: false
#| output: false
# setup
rm(list=ls())
library(data.table)
library(ggplot2)
library(ggdag)
library(dagitty)
library(gridExtra)

## define useful functions
expit <- function(x) {exp(x)/(1+exp(x))}

## small number to have more likelihood for imbalance
N <- 30
niter <- 1:1000
```

## Analysis

### Overview
(1) Simulated RCT data using multiple data generating processes for comparison.

(2) Fit generalized linear models with varied specifications to estimate the effect of treatment on the outcome of interest, comparing error over many simulations, as well as examining relationship between error and the baseline imbalance in the outcome.

### Data Generating Processes

I tested multiple data generating processes to understand in which contexts different modeling strategies led to different results:

(1) $Y_{1}=\beta_0 + \beta_X X + \beta_{Y_0} Y_{0} + \epsilon$

(2) $Y_{1}=\beta_0 + \beta_X X + \beta_{Y_0} Y_{0} + \beta_{X*Y_0} X*Y_{0} + \epsilon$

where $X$ is treatment, $Y_{0}$ is the baseline measure of the outcome before treatment, and $Y_{1}$ is the post-treatment outcome.

```{r}
#| echo: false

dag1 <- dagitty::dagitty(
'dag {
  "X*Y0" [pos="0.1,0.357"]
  X [exposure,pos="-0.239,-0.459"]
  Y0 [pos="-0.129,1.076"]
  Y1 [outcome,pos="0.752,0.464"]
  X -> "X*Y0"
  X -> Y1
  Y0 -> "X*Y0"
  Y0 -> Y1
}'
)

dag2 <- dagitty::dagitty(
'dag {
  "X*Y0" [pos="0.1,0.357"]
  X [exposure,pos="-0.239,-0.459"]
  Y0 [pos="-0.129,1.076"]
  Y1 [outcome,pos="0.752,0.464"]
  "X*Y0" -> Y1
  X -> "X*Y0"
  X -> Y1
  Y0 -> "X*Y0"
  Y0 -> Y1
}'
)

gg1 <- ggdag(dag1, layout = "circle") + theme_dag_blank() + annotate("text",x=.45,y=.48,label="Effect = 0") + ggtitle("DGP 1: No Interaction\n(on Additive Scale)")

gg2 <- ggdag(dag2, layout = "circle") + theme_dag_blank() + 
  annotate("text",x=.45,y=.48,label="Effect =/= 0") + ggtitle("DGP 2: Interaction\n(on Additive Scale)")

grid.arrange(gg1, gg2, nrow = 1)

#ggplot(dag)


```

### Models Fit

I compared the following analytic approaches (names from Twisk et al., 2018):

(1) "Longitudinal Analysis of Covariance"
(a) Unsaturated
$Y_t=\beta_0 + \beta_X X + \beta_{Y_0} Y_0 + \epsilon$
(b) Saturated
$Y_t=\beta_0 + \beta_X X + \beta_{Y_0} Y_0 + \beta_{X*Y_0} X*Y_0 + \epsilon$

(2) "Repeated Measures Analysis" (Difference in Differences)
$Y_t=\beta_0 + \beta_X X + \beta_{time} time + \beta_{time*X} time*X + \epsilon$



### Results


```{r}
#| echo: false

## DATA GENERATING PROCESS 1

bd <- c()
m1 <- c()
m2 <- c()
for (i in niter) {
  cat(paste0(i)); flush.console()
  ## generate data
  tx <- sample(x=1:N,size=.5*N) ## make treatment randomization exactly 50%
  ## continuous first because it seems easier
  Y0 <- rnorm(n=N,mean=10,sd=1.5)
  E <- as.numeric(c(1:N) %in% tx)
  Y1 <- (1*Y0 + E*(-2) + rnorm(n=N,mean=0,sd=.2))
  id=1:N
  d <- data.table(as.data.frame(cbind(Y0,E,Y1,id)))
  
  ## data formatted for DiD
  d2 <- melt(copy(d),id.vars=c("id","E"),variable.name="time",value.name="Y")
  d2[,time:=as.numeric(substr(time,2,3))]
  d2[,id:=factor(id)]
  
  ## find imbalance in baseline values
  bd[i] <- mean(d[E==1]$Y0)-mean(d[E==0]$Y0)
  
  ## regression models
  mod1 <- lm(data=d2,formula="Y ~ E + time + E*time")
  # did2 <- lmer(data=d2,formula="Y ~ E + time + E*time + (1 | id)") in this case exactly the same
  mod2 <- lm(data=d,formula="Y1 ~ Y0 + E")
  m1[i] <- summary(mod1)$coefficients["E:time","Estimate"]
  m2[i] <- summary(mod2)$coefficients["E","Estimate"]
    
}

m1diff <- abs(m1+2)
m2diff <- abs(m2+2)
mean(m1)
mean(m2)
summary(lm(m1diff ~ bd))
summary(lm(m2diff ~ bd))
mean(bd)

```

Notes:

Note to look back: https://diff.healthpolicydatascience.org/#regression

not the same but maybe related https://www.sciencedirect.com/science/article/abs/pii/S0304407614002437?via%3Dihub https://onlinelibrary.wiley.com/doi/10.1111/1475-6773.13017 https://onlinelibrary.wiley.com/doi/full/10.1111/1475-6773.13015 https://pubmed.ncbi.nlm.nih.gov/33978956/

Note: ATT/ATE? IS THE FACT THAT IT IS ATT SOMEHOW ENCODED IN GRAPH? HOW CAN WE EXPLAIN THE TRANSFORMATION OF THE GRAPH?

Note: Do with continuous X too?
